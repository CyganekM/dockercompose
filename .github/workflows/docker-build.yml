name: Build and Push Docker Image

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Log in to GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. Log in to Docker Hub (опционально)
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 5. Вычисляем lowercase имя образа
      - name: Set image name
        id: set-image
        run: |
          # Преобразуем имя репозитория в lowercase
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "Using image name: ${IMAGE_NAME}"

      # 6. Extract metadata for Docker
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.set-image.outputs.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=sha,prefix=commit-

      # 7. Build and push Docker image
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

          # 8. Run container tests
      - name: Run container tests
        if: github.event_name != 'pull_request'
        run: |
          # Сначала стопим старый контейнер если есть
          docker stop test-container || true
          docker rm test-container || true
          
          # Получаем имя образа
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_FULL="${{ env.REGISTRY }}/${IMAGE_NAME}:main"
          
          echo "Testing image: ${IMAGE_FULL}"
          
          # Запускаем новый контейнер БЕЗ порта (чтобы не конфликтовать)
          docker run --name test-container -d \
          -e SPRING_PROFILES_ACTIVE=test \
          -e SPRING_DATASOURCE_URL=jdbc:h2:mem:testdb \
          -e SPRING_H2_CONSOLE_ENABLED=true \
          -e SPRING_JPA_HIBERNATE_DDL_AUTO=create-drop \
          ${IMAGE_FULL}
          
          # Ждем инициализации приложения
          echo "Waiting for Spring Boot to start..."
          sleep 30
          
          # Проверяем логи на успешный запуск
          echo "Checking application logs..."
          if docker logs test-container | grep -q "Started DemoApplication"; then
          echo "✅ Spring Boot started successfully"
          else
          echo "❌ Spring Boot failed to start"
          docker logs test-container
          exit 1
          fi
          
          # Проверяем что приложение слушает порт
          echo "Checking if application is listening..."
          if docker exec test-container netstat -tuln | grep -q ":8080"; then
          echo "✅ Application is listening on port 8080"
          else
          echo "❌ Application is not listening on port 8080"
          docker exec test-container netstat -tuln
          exit 1
          fi
          
          # Останавливаем контейнер
          docker stop test-container
          echo "✅ All tests passed!"

      # 9. Telegram Notification on Success
      - name: Telegram Notification Success
        if: success() && github.event_name != 'pull_request'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ✅ *Docker Build Success*
            
            *Repository:* ${{ github.repository }}
            *Branch:* ${{ github.ref_name }}
            *Commit:* ${{ github.sha }}
            *Author:* ${{ github.actor }}
            
            *Image:* ${{ env.REGISTRY }}/${{ steps.set-image.outputs.IMAGE_NAME }}:main
            *Status:* ✅ Build and tests completed successfully
            
            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown

      # 10. Telegram Notification on Failure
      - name: Telegram Notification Failure
        if: failure() && github.event_name != 'pull_request'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ❌ *Docker Build Failed*
            
            *Repository:* ${{ github.repository }}
            *Branch:* ${{ github.ref_name }}
            *Commit:* ${{ github.sha }}
            *Author:* ${{ github.actor }}
            
            *Status:* ❌ Build or tests failed
            
            [View Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown